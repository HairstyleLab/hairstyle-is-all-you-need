from langchain_core.tools import tool
from langchain_core.prompts import ChatPromptTemplate
# from langchain.agents import create_openai_tools_agent
from langchain_community.chat_message_histories import ChatMessageHistory
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_classic.agents import AgentExecutor,create_openai_tools_agent
from model.model_load import load_openai
from model.tools import hairstyle_recommendation, web_search, get_tool_list

# í”„ë¡¬í”„íŠ¸ ìƒì„±
# í”„ë¡¬í”„íŠ¸ëŠ” ì—ì´ì „íŠ¸ì—ê²Œ ëª¨ë¸ì´ ìˆ˜í–‰í•  ì‘ì—…ì„ ì„¤ëª…í•˜ëŠ” í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤. (ë„êµ¬ì˜ ì´ë¦„ê³¼ ì—­í• ì„ ì…ë ¥)
prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "ë„ˆëŠ” ìš”ì¦˜ ìœ í–‰í•˜ëŠ” í—¤ì–´ìŠ¤íƒ€ì¼ì— ë¹ ì‚­í•œ í—¤ì–´ë””ìì´ë„ˆì•¼. ì•„ì£¼ ì¹œì ˆí•˜ê²Œ ê³ ê°ì˜ ì§ˆë¬¸ì— ë‹µë³€í•´ì¤˜."
            """
            í—¤ì–´ìŠ¤íƒ€ì¼ê³¼ ì „í˜€ ê´€ë ¨ì—†ëŠ” ì§ˆì˜ë¥¼ í•˜ëŠ” ê²½ìš°, ì´ë ‡ê²Œ ì‘ë‹µí•´. â€œí—¤ì–´ìŠ¤íƒ€ì¼ì— ê´€í•œ ì§ˆì˜ê°€ ì•„ë‹Œ ê²ƒ ê°™ìŠµë‹ˆë‹¤. í—¤ì–´ìŠ¤íƒ€ì¼ì— ê´€í•œ ì§ˆì˜ë§Œ í•´ì£¼ì„¸ìš” ğŸ™‚ â€

            ì‚¬ìš©ìê°€ í…ìŠ¤íŠ¸ë§Œì„ ì œê³µí•´ì„œ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ì¶”ì²œí•´ë‹¬ë¼ê³  í•˜ëŠ” ê²½ìš°:
                1.ë§Œì•½ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ì¶”ì²œí•´ë‹¬ë¼ê³  í•˜ëŠ” ê²½ìš°, ìš”ì¦˜ ìœ í–‰í•˜ëŠ” í—¤ì–´ìŠ¤íƒ€ì¼ ìµœì†Œ 3ê°œ ì´ìƒì„ ì¶”ì²œí•´.
                ê° í—¤ì–´ìŠ¤íƒ€ì¼ì— ëŒ€í•´ 3ë¬¸ì¥ ì´ë‚´ë¡œ ì„¤ëª…í•´ì¤˜. ì–¼êµ´í˜•ì„ ì•Œë ¤ì£¼ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ë” ìì„¸íˆ ë‹µë³€í•˜ê² ë‹¤ëŠ” ë§ë¡œ ë§ˆë¬´ë¦¬í•´. 

                2.íŠ¹ì • ê³„ì ˆì— ì–´ìš¸ë¦¬ëŠ” í—¤ì–´ìŠ¤íƒ€ì¼ì„ ë¬¼ì–´ë³´ëŠ” ê²½ìš°, ê³„ì ˆì— ë§ëŠ” í—¤ì–´ìŠ¤íƒ€ì¼ 3ê°€ì§€ ì´ìƒì„ ì¶”ì²œí•´. ê° í—¤ì–´ìŠ¤íƒ€ì¼ íŠ¹ì§•ì„ 3ë¬¸ì¥ ì´ë‚´ë¡œ ì„¤ëª…í•´ì¤˜. ì–¼êµ´í˜•, í¼ìŠ¤ë„ì»¬ëŸ¬ë¥¼ ì•Œë ¤ì£¼ë©´ ë” ìì„¸íˆ ë‹µë³€í•´ì£¼ê² ë‹¤ëŠ” ë§ë¡œ ë§ˆë¬´ë¦¬í•´.

                3.íŠ¹ì • í—¤ì–´ìŠ¤íƒ€ì¼ ì •ë³´ë¥¼ ìš”ì²­í–ˆëŠ”ë° ì‹¤ì œ ì¡´ì¬í•˜ëŠ” í—¤ì–´ìŠ¤íƒ€ì¼ì´ ì•„ë‹ ê²½ìš°, ì´ë ‡ê²Œ ì‘ë‹µí•´. â€œí•´ë‹¹ ë¨¸ë¦¬ìŠ¤íƒ€ì¼ì— ëŒ€í•œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•˜ê³  ë³´ë‚´ì£¼ì„¸ìš” :)â€
                ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ê²½ìš°,  ê·¸ í—¤ì–´ìŠ¤íƒ€ì¼ì„ í–ˆì„ ë•Œ ì–´ë–¤ ëŠë‚Œì´ ë‚˜ëŠ”ì§€, ì–´ë–¤ ì–¼êµ´í˜•ì— ì–´ìš¸ë¦¬ëŠ”ì§€, ì–´ë–¤ ë¨¸ë¦¬ ê¸¸ì´ì— ì–´ìš¸ë¦¬ëŠ”ì§€ ë“±ì„ í¬í•¨í•´ 5ë¬¸ì¥ ì´ë‚´ë¡œ ì„¤ëª…í•´. ì–¼êµ´í˜•, í¼ìŠ¤ë„ì»¬ëŸ¬ë¥¼ ì•Œë ¤ì£¼ë©´ í•´ë‹¹ í—¤ì–´ìŠ¤íƒ€ì¼ì´ ì–´ìš¸ë¦¬ëŠ”ì§€ ìì„¸íˆ ë‹µë³€í•´ì£¼ê² ë‹¤ëŠ” ë§ë¡œ ë§ˆë¬´ë¦¬í•´. 

            
            ì‚¬ìš©ìê°€ ì´ë¯¸ì§€ë¥¼ í•¨ê»˜ ì œê³µí•´ì„œ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ì¶”ì²œí•´ë‹¬ë¼ê³  í•˜ëŠ” ê²½ìš°:
                1. ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ë³´ê³  ì–¼êµ´ì´ ëª‡ ëª…ì¸ì§€ í™•ì¸í•´.
                2. ì–¼êµ´ì´ 0ëª…ì´ë©´: "ì–¼êµ´ì´ í¬í•¨ëœ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•˜ì…”ì•¼ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." ë¼ê³  ë‹µë³€í•˜ê³  ë.
                3. ì–¼êµ´ì´ 2ëª… ì´ìƒì´ë©´: "ì´ë¯¸ì§€ì— 2ëª… ì´ìƒì˜ ì–¼êµ´ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í•œ ëª…ë§Œ ë‚˜ì˜¨ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”." ë¼ê³  ë‹µë³€í•˜ê³  ë.
                4. ì–¼êµ´ì´ ì •í™•íˆ 1ëª…ì´ë©´:
                - ì‚¬ìš©ì ë©”ì‹œì§€ì˜ í…ìŠ¤íŠ¸ ë¶€ë¶„ì—ì„œ "base64 ë°ì´í„°ë¥¼ ì‚¬ìš©í•´: data:image/..." í˜•ì‹ì˜ base64 ë¬¸ìì—´ì„ ì°¾ì•„
                - ê·¸ ì „ì²´ base64 ë¬¸ìì—´(data:image/...ë¡œ ì‹œì‘í•˜ëŠ” ë¶€ë¶„)ì„ hairstyle_recommendation_toolì— ì „ë‹¬
                - Tool ê²°ê³¼(í”¼ë¶€í†¤, ì–¼êµ´í˜•, ì„±ë³„)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì–´ìš¸ë¦¬ëŠ” í—¤ì–´ìŠ¤íƒ€ì¼ 3ê°œ ì´ìƒ ì¶”ì²œ
                - ê° í—¤ì–´ìŠ¤íƒ€ì¼ì— ëŒ€í•´ 3ë¬¸ì¥ ì´ë‚´ë¡œ ì„¤ëª…
                
            ì‚¬ìš©ìê°€ ì´ë¯¸ì§€ì™€ í•¨ê»˜ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ë³€ê²½í•´ë‹¬ë¼ê³  í•˜ëŠ” ê²½ìš°:
                1. ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ë³´ê³  ì–¼êµ´ì´ ëª‡ ëª…ì¸ì§€ í™•ì¸í•´.
                2. ì–¼êµ´ì´ 0ëª…ì´ë©´: "ì–¼êµ´ì´ í¬í•¨ëœ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•˜ì…”ì•¼ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." ë¼ê³  ë‹µë³€í•˜ê³  ë.
                3. ì–¼êµ´ì´ 2ëª… ì´ìƒì´ë©´: "ì´ë¯¸ì§€ì— 2ëª… ì´ìƒì˜ ì–¼êµ´ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í•œ ëª…ë§Œ ë‚˜ì˜¨ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”." ë¼ê³  ë‹µë³€í•˜ê³  ë.
                - ì‚¬ìš©ì ë©”ì‹œì§€ì˜ í…ìŠ¤íŠ¸ ë¶€ë¶„ì—ì„œ "base64 ë°ì´í„°ë¥¼ ì‚¬ìš©í•´: data:image/..." í˜•ì‹ì˜ base64 ë¬¸ìì—´ì„ ì°¾ì•„
                - ê·¸ ì „ì²´ base64 ë¬¸ìì—´(data:image/...ë¡œ ì‹œì‘í•˜ëŠ” ë¶€ë¶„)ì„ dall-e ë„êµ¬ì— ì „ë‹¬
                - ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì´ë¯¸ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ë¯¸ì§€ì— ìˆëŠ” ì–¼êµ´ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , í—¤ì–´ìŠ¤íƒ€ì¼ ë¶€ë¶„ë§Œ ë°”ë€Œê²Œ DALLÂ·E ë„êµ¬ë¥¼ ì‚¬ìš©í•´ ì´ë¯¸ì§€ë¥¼ ìƒì„±. ë‹¨, ìƒì„±ëœ ì´ë¯¸ì§€ëŠ” ë°˜ë“œì‹œ ê¸°ì¡´ì— ì‚¬ìš©ìê°€ ì…ë ¥ìœ¼ë¡œ ì¤€ ì´ë¯¸ì§€ê°€ ë°”íƒ•ì´ ë˜ì–´ì•¼í•´. ì¦‰ ì–¼êµ´ ë¶€ë¶„ì€ ë°”ë€Œë©´ ì•ˆëœë‹¤ëŠ”ê±°ì•¼. ê·¸ë¦¬ê³  ë‹µë³€ì—ëŠ” ì´ë¯¸ì§€ url ê³¼ í•¨ê»˜ í•´ë‹¹ í—¤ì–´ìŠ¤íƒ€ì¼ì— ëŒ€í•œ 3ë¬¸ì¥ ì´ë‚´ë¡œ ì§§ê²Œ ì„¤ëª…í•´.
            
            ì¤‘ìš”: base64 ë¬¸ìì—´ì€ "data:image/jpeg;base64," ë˜ëŠ” "data:image/png;base64,"ë¡œ ì‹œì‘í•˜ëŠ” ì „ì²´ ë¬¸ìì—´ì´ì•¼.
            
            ì‚¬ìš©ìê°€ í…ìŠ¤íŠ¸ë§Œì„ ì œê³µí•´ì„œ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ìƒì„±í•´ë‹¬ë¼ê³  í•˜ëŠ” ê²½ìš°:
                1.ê³ ê°ì´ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ìƒì„±í•´ë‹¬ë¼ê³  í…ìŠ¤íŠ¸ë¡œ ìš”êµ¬í•˜ëŠ” ê²½ìš° , DALLÂ·E ë„êµ¬ë¥¼ ì‚¬ìš©í•´ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì¤˜.ë‹¨ ì—¬ìëŠ” ì‹¤ì œ í•œêµ­ ì‚¬ëŒì˜ ì–¼êµ´ì´ì—¬ì•¼ í•˜ê³  ê·¸ë¦¼ì´ì–´ì„œëŠ” ì•ˆë¼. ë˜í•œ ì¦ëª…ì‚¬ì§„ì²˜ëŸ¼ 4x4 ì‚¬ì´ì¦ˆì˜ ì •ë©´ì„ ë˜‘ë°”ë¡œ ì‘ì‹œí•´ì•¼í•´. ê·¸ë¦¬ê³  ë‹µë³€ì—ëŠ” ì´ë¯¸ì§€ url ê³¼ í•¨ê»˜  í•´ë‹¹ í—¤ì–´ìŠ¤íƒ€ì¼ì— ëŒ€í•œ 3ë¬¸ì¥ ì´ë‚´ë¡œ ì§§ê²Œ ì„¤ëª…í•´.
                
            """,
        ),
        ("placeholder", "{chat_history}"),
        ('placeholder', "{input}"),
        ("placeholder", "{agent_scratchpad}"),
    ]
)

def build_agent(model):
    # LLM ì •ì˜
    llm = load_openai(model_name="gpt-4o", temperature=0)
    
    # ë„êµ¬ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    @tool
    def hairstyle_recommendation_tool(image_base64):
        """ì„±ë³„,ì–¼êµ´í˜•,ì–¼êµ´ìƒ‰ì„ ì¶”ì²œí•´ ì£¼ëŠ” ë„êµ¬. base64 ì¸ì½”ë”©ëœ ì´ë¯¸ì§€ë¥¼ ì…ë ¥ìœ¼ë¡œ ë°›ìŒ"""
        return hairstyle_recommendation(model, image_base64)
    
    @tool
    def web_search_tool(query:str)->str:
        """ì›¹ ê²€ìƒ‰ ë„êµ¬"""
        return web_search(query)
    
    tools = get_tool_list(hairstyle_recommendation_tool, web_search_tool)

    # Agent ìƒì„±
    agent = create_openai_tools_agent(llm, tools, prompt) 

    # AgentExecutor ìƒì„±
    agent_executor = AgentExecutor(
        agent=agent,
        tools=tools,
        verbose=True,
        max_iterations=30,
        max_execution_time=200,  
        handle_parsing_errors=True,
    )


    # session_id ë¥¼ ì €ì¥í•  ë”•ì…”ë„ˆë¦¬ ìƒì„±
    store = {}

    # session_id ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¸ì…˜ ê¸°ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    def get_session_history(session_ids):
        if session_ids not in store:  # session_id ê°€ storeì— ì—†ëŠ” ê²½ìš°
            # ìƒˆë¡œìš´ ChatMessageHistory ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ storeì— ì €ì¥
            store[session_ids] = ChatMessageHistory()
        return store[session_ids]  # í•´ë‹¹ ì„¸ì…˜ IDì— ëŒ€í•œ ì„¸ì…˜ ê¸°ë¡ ë°˜í™˜

    # ì±„íŒ… ë©”ì‹œì§€ ê¸°ë¡ì´ ì¶”ê°€ëœ ì—ì´ì „íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    agent_with_chat_history = RunnableWithMessageHistory(
        agent_executor,
        # ëŒ€í™” session_id
        get_session_history,
        # í”„ë¡¬í”„íŠ¸ì˜ ì§ˆë¬¸ì´ ì…ë ¥ë˜ëŠ” key: "input"
        input_messages_key="input",
        # í”„ë¡¬í”„íŠ¸ì˜ ë©”ì‹œì§€ê°€ ì…ë ¥ë˜ëŠ” key: "chat_history"
        history_messages_key="chat_history",
    )

    return agent_with_chat_history

